# Gumroad Webhook Configuration Guide

## Your Webhook URL
```
https://us-central1-projects-corporatespec.cloudfunctions.net/gumroadWebhook
```

## Step 1: Configure Webhook in Gumroad

1. **Go to Gumroad Settings**
   - Log in to https://app.gumroad.com
   - Click on your profile picture (top right)
   - Select **"Settings"**

2. **Navigate to Advanced Settings**
   - In the left sidebar, click **"Advanced"**
   - Scroll down to find the **"Webhooks"** section
   - OR go directly to: https://app.gumroad.com/settings/advanced#webhooks-form

3. **Add Webhook**
   - Click **"Create a webhook"** or **"Add webhook"**
   - In the **"Ping URL"** field, paste:
     ```
     https://us-central1-projects-corporatespec.cloudfunctions.net/gumroadWebhook
     ```

4. **Select Events** (Check ALL of these):
   - ✅ `sale` - When a purchase is made
   - ✅ `refund` - When a refund is issued  
   - ✅ `cancellation` - When a subscription is cancelled
   - ✅ `subscription_updated` - When subscription is updated
   - ✅ `subscription_ended` - When subscription ends
   - ✅ `subscription_restarted` - When subscription restarts

5. **Save**
   - Click **"Create webhook"** or **"Save"**
   - Gumroad will send a test ping to verify the webhook works

## Step 2: Add Custom Field to Your Product

This is CRITICAL - without this, the webhook won't know which user made the purchase.

1. **Go to Your Product**
   - Navigate to https://app.gumroad.com/products
   - Click on your "CrewQuo Subcontractor Managing Platform" product

2. **Edit Product Settings**
   - Scroll down to find **"Customize fields"** or **"Custom fields"**
   - Click **"Add custom field"** or **"+"**

3. **Add user_id Field**
   - **Field label**: `user_id` (exactly as written)
   - **Field type**: **Hidden** (recommended) or **Text**
   - **Required**: ✅ Yes
   - **Default value**: Leave empty
   
4. **Save Product**

## Step 3: How It Works

When a user clicks "Subscribe" in your app:
1. Your app generates a Gumroad checkout URL with their user ID
2. User is redirected to Gumroad to complete payment
3. After successful payment, Gumroad sends a webhook to your Firebase function
4. The function receives the user_id and tier name
5. Your database is automatically updated with subscription status

## Step 4: Test the Webhook

### Option 1: Check Gumroad Webhook History
1. Go to https://app.gumroad.com/settings/advanced#webhooks-form
2. Click on your webhook
3. You should see the test ping with a green checkmark
4. If there's an error, check Firebase function logs

### Option 2: Make a Test Purchase (Recommended)
1. Go to your pricing page (you'll create this next)
2. Click on a tier to purchase
3. Complete the Gumroad checkout
4. Check Firebase Console → Firestore to see if your user document was updated

### Checking Firebase Logs
```bash
firebase functions:log --only gumroadWebhook
```

Or visit: https://console.firebase.google.com/project/projects-corporatespec/functions

## Important Notes

### About Tier Detection
The webhook function detects which tier was purchased using:
1. **Tier name** from Gumroad (Personal, Business Starter, Business Pro)
2. **Price** as fallback (£99, £199, £349 monthly)

### User ID Passing
- For testing: You can manually add `?wanted=true` to the URL
- For production: Your app must generate the checkout URL with the user's ID embedded
- The checkout URL is generated by `generateGumroadCheckoutUrl()` in `lib/gumroad.ts`

## Troubleshooting

### Webhook Not Receiving Data
1. Check that webhook URL is correct in Gumroad
2. Verify webhook is enabled
3. Check Firebase function logs for errors
4. Ensure the Firebase function deployed successfully

### User ID Not Being Captured
1. Verify custom field `user_id` is added to product
2. Check that field name is exactly `user_id` (case-sensitive)
3. Ensure your checkout URL includes the user_id

### Tier Not Being Detected Correctly
1. Check Firebase function logs to see what data Gumroad is sending
2. The function logs: `'Determining plan from:'` with the tier details
3. Ensure tier names in Gumroad match: "Personal", "Business Starter", "Business Pro"

### Testing with Curl
```bash
curl -X POST https://us-central1-projects-corporatespec.cloudfunctions.net/gumroadWebhook \
  -H "Content-Type: application/json" \
  -d '{
    "sale_id": "test123",
    "user_id": "YOUR_TEST_USER_ID",
    "email": "test@example.com",
    "product_name": "Personal",
    "variant_name": "Personal",
    "subscription_id": "sub_test123",
    "price": "9900"
  }'
```

## Next Steps

1. ✅ Webhook configured in Gumroad
2. ✅ Custom field added to product  
3. ⏳ Create pricing page in your app
4. ⏳ Test complete purchase flow
5. ⏳ Monitor webhook processing

---

**Need Help?**
- Check Firebase function logs: `firebase functions:log --only gumroadWebhook`
- View Gumroad webhook history: https://app.gumroad.com/settings/advanced#webhooks-form
- Firebase Console: https://console.firebase.google.com/project/projects-corporatespec/functions
