rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function authed() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.isSuperAdmin == true;
    }
    
    function companyId() {
      return request.auth.token.companyId;
    }
    
    function ownCompanyId() {
      return request.auth.token.ownCompanyId;
    }
    
    function activeCompanyId() {
      return request.auth.token.activeCompanyId;
    }
    
    function userRole() {
      return request.auth.token.role;
    }
    
    function sameCompany(data) {
      return data.companyId == companyId();
    }
    
    function sameActiveCompany(data) {
      return data.companyId == activeCompanyId();
    }
    
    function isOwnCompany() {
      return activeCompanyId() == ownCompanyId();
    }
    
    function hasAccessToCompany(compId) {
      return compId == ownCompanyId() || 
             (request.auth.token.subcontractorRoles != null && 
              compId in request.auth.token.subcontractorRoles);
    }

    function subcontractorIdForActiveCompany() {
      return (request.auth.token.subcontractorRoles != null && activeCompanyId() in request.auth.token.subcontractorRoles)
        ? request.auth.token.subcontractorRoles[activeCompanyId()].subcontractorId
        : null;
    }
    
    function isAdmin() {
      return userRole() == 'ADMIN';
    }
    
    function isManager() {
      return userRole() == 'MANAGER';
    }
    
    function isSubcontractor() {
      return userRole() == 'SUBCONTRACTOR';
    }
    
    function isAdminOrManager() {
      return userRole() in ['ADMIN', 'MANAGER'];
    }
    
    // System Settings (Super Admin Only)
    match /systemSettings/{docId} {
      allow read: if authed();
      allow write: if isSuperAdmin();
    }
    
    // Companies collection
    match /companies/{compId} {
      allow read: if isSuperAdmin() || (authed() && hasAccessToCompany(compId));
      allow create: if authed(); // Signup creates company
      allow update: if isSuperAdmin() || (authed() && compId == ownCompanyId() && isAdmin());
      allow delete: if isSuperAdmin();
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSuperAdmin() || (authed() && (
        request.auth.uid == userId ||
        hasAccessToCompany(resource.data.ownCompanyId)
      ));
      // Allow user creation during signup
      allow create: if request.auth.uid == userId;
      // Allow user to update their own document, admins in their own company, or super admin
      allow update: if isSuperAdmin() || (authed() && (
        request.auth.uid == userId ||
        (resource.data.ownCompanyId == ownCompanyId() && isAdmin())
      ));
      allow delete: if isSuperAdmin();
    }
    
    // Role Catalog
    match /roleCatalog/{roleId} {
      allow read: if authed() && hasAccessToCompany(resource.data.companyId);
      allow write: if authed() && sameCompany(request.resource.data) && isAdminOrManager();
    }
    
    // Clients
    match /clients/{clientId} {
      allow read: if authed() && hasAccessToCompany(resource.data.companyId);
      // Can only create in own company
      allow create: if authed() 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
      allow update: if authed() 
        && sameActiveCompany(resource.data) 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
      allow delete: if authed() 
        && sameActiveCompany(resource.data) 
        && isOwnCompany()
        && isAdmin();
    }
    
    // Subcontractors
    match /subcontractors/{subcontractorId} {
      // Allow unauthenticated queries/reads for invite validation (both list and get)
      allow get: if !authed() && resource.data.inviteToken != null && resource.data.inviteStatus == 'pending';
      allow list: if !authed(); // Allow queries for invite token validation
      
      // Authenticated users can see subcontractors - in own company or companies they work for
      allow read: if authed() && hasAccessToCompany(resource.data.companyId);
      
      // Can only create in own company
      allow create: if authed() 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
      
      allow update: if (
        // Allow unauthenticated update during signup (accept invite)
        (!authed() && resource.data.inviteToken != null && resource.data.inviteStatus == 'pending')
        ||
        // Allow authenticated update during signup (accept invite) - before custom claims are set
        (authed() 
          && resource.data.inviteToken != null 
          && resource.data.inviteStatus == 'pending'
          && request.resource.data.inviteStatus == 'accepted'
          && request.resource.data.userId == request.auth.uid)
        ||
        // Regular authenticated updates in own company
        (authed() && sameActiveCompany(resource.data) && isOwnCompany() && isAdminOrManager())
      );
      
      allow delete: if authed() 
        && sameActiveCompany(resource.data) 
        && isOwnCompany()
        && isAdmin();
    }
    
    // Invites collection
    match /invites/{inviteId} {
      // Users can read their own pending invites
      allow read: if authed() && resource.data.email == request.auth.token.email;
      // Companies can read their sent invites
      allow read: if authed() && sameActiveCompany(resource.data);
      // Can create in own company
      allow create: if authed() 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
      // Update to accept/reject
      allow update: if authed() && resource.data.email == request.auth.token.email;
      allow delete: if authed() 
        && sameActiveCompany(resource.data) 
        && isOwnCompany()
        && isAdmin();
    }
    
    // Projects
    match /projects/{projectId} {
      // Allow read if user has access to the company
      allow read: if authed() && hasAccessToCompany(resource.data.companyId);
      // Can only create in own company
      allow create: if authed() 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
      allow update: if authed() 
        && sameActiveCompany(resource.data) 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
      allow delete: if authed() 
        && sameActiveCompany(resource.data) 
        && isOwnCompany()
        && isAdmin();
    }
    
    // Project Assignments
    match /projectAssignments/{assignmentId} {
      // Allow read if user has access to the company (own company, active company, or through subcontractor role)
      allow read: if authed() && (
        resource.data.companyId == ownCompanyId() ||
        sameActiveCompany(resource.data) || 
        hasAccessToCompany(resource.data.companyId)
      );
      // Can only create in own company - prevent duplicates by checking no existing assignment
      allow create: if authed() 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager()
        && !exists(/databases/$(database)/documents/projectAssignments/$(request.resource.data.projectId + '_' + request.resource.data.subcontractorId));
      allow update: if authed() 
        && sameActiveCompany(resource.data) 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
      allow delete: if authed() 
        && sameActiveCompany(resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
    }
    
    // Rate Card Templates
    match /rateCardTemplates/{templateId} {
      // Allow read if user has access to the company (own company or through subcontractor role)
      allow read: if authed() && hasAccessToCompany(resource.data.companyId);
      allow create: if authed() && sameCompany(request.resource.data) && isAdminOrManager();
      allow update: if authed() && sameCompany(resource.data) && sameCompany(request.resource.data) && isAdminOrManager();
      allow delete: if authed() && sameCompany(resource.data) && isAdmin();
    }
    
    // Rate Cards
    match /rateCards/{rateCardId} {
      // Allow read based on card type and user role
      allow read: if authed() && hasAccessToCompany(resource.data.companyId) && (
        // Own company: can see all cards
        isOwnCompany() ||
        // Subcontractors: can only see PAY cards (not BILL cards which contain client billing rates)
        (!isOwnCompany() && (!exists(['cardType']) || resource.data.cardType == 'PAY'))
      );
      allow create: if authed() && sameCompany(request.resource.data) && isAdminOrManager() 
        && request.resource.data.keys().hasAll(['companyId', 'name', 'rates', 'active']);
      allow update: if authed() && sameCompany(resource.data) && sameCompany(request.resource.data) && isAdminOrManager();
      allow delete: if authed() && sameCompany(resource.data) && isAdmin();
    }
    
    // Subcontractor Rate Assignments
    match /subcontractorRateAssignments/{assignmentId} {
      // Allow read if user has access to the company (own company, active company, or through subcontractor role)
      allow read: if authed() && hasAccessToCompany(resource.data.companyId);
      allow create: if authed() && sameActiveCompany(request.resource.data) && isOwnCompany() && isAdminOrManager();
      allow update: if authed() && sameActiveCompany(resource.data) && sameActiveCompany(request.resource.data) && isOwnCompany() && isAdminOrManager();
      allow delete: if authed() && sameActiveCompany(resource.data) && isOwnCompany() && isAdminOrManager();
    }
    
    // Time Logs
    match /timeLogs/{timeLogId} {
      allow read: if authed() && sameActiveCompany(resource.data);
      
      allow create: if authed()
        && sameActiveCompany(request.resource.data)
        && (
          // In own company: admins/managers can create
          (isOwnCompany() && isAdminOrManager())
          ||
          // In subcontractor context: can create own logs (always DRAFT status)
          (!isOwnCompany() 
            && request.resource.data.createdByUserId == request.auth.uid
            && request.resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && request.resource.data.status == 'DRAFT')
        );
      
      allow update: if authed()
        && sameActiveCompany(resource.data)
        && sameActiveCompany(request.resource.data)
        && (
          // In own company: admins/managers can update and approve/reject
          (isOwnCompany() && isAdminOrManager())
          ||
          // In subcontractor context: can edit own DRAFT logs or change them to SUBMITTED for timesheet submission
          (!isOwnCompany() 
            && resource.data.createdByUserId == request.auth.uid
            && resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && resource.data.status == 'DRAFT'
            && request.resource.data.status in ['DRAFT', 'SUBMITTED'])
        );
      
      allow delete: if authed() 
        && sameActiveCompany(resource.data)
        && (
          // Company can delete DRAFT logs
          (isOwnCompany() && isAdmin())
          ||
          // Subcontractor can delete own DRAFT logs
          (!isOwnCompany()
            && resource.data.createdByUserId == request.auth.uid
            && resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && resource.data.status == 'DRAFT')
        );
    }
    
    // Expenses
    match /expenses/{expenseId} {
      allow read: if authed() && sameActiveCompany(resource.data);
      
      allow create: if authed()
        && sameActiveCompany(request.resource.data)
        && (
          // In own company: admins/managers can create
          (isOwnCompany() && isAdminOrManager())
          ||
          // In subcontractor context: can create own expenses (always DRAFT status)
          (!isOwnCompany() 
            && request.resource.data.createdByUserId == request.auth.uid
            && request.resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && request.resource.data.status == 'DRAFT')
        );
      
      allow update: if authed()
        && sameActiveCompany(resource.data)
        && sameActiveCompany(request.resource.data)
        && (
          // In own company: admins/managers can update and approve/reject
          (isOwnCompany() && isAdminOrManager())
          ||
          // In subcontractor context: can edit own DRAFT expenses or change them to SUBMITTED for timesheet submission
          (!isOwnCompany() 
            && resource.data.createdByUserId == request.auth.uid
            && resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && resource.data.status == 'DRAFT'
            && request.resource.data.status in ['DRAFT', 'SUBMITTED'])
        );
      
      allow delete: if authed() 
        && sameActiveCompany(resource.data)
        && (
          // Company can delete DRAFT expenses
          (isOwnCompany() && isAdmin())
          ||
          // Subcontractor can delete own DRAFT expenses
          (!isOwnCompany()
            && resource.data.createdByUserId == request.auth.uid
            && resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && resource.data.status == 'DRAFT')
        );
    }
    
    // Project Submissions
    match /projectSubmissions/{submissionId} {
      allow read: if authed() && sameActiveCompany(resource.data);
      
      allow create: if authed()
        && sameActiveCompany(request.resource.data)
        && (
          // In own company: admins/managers can create
          (isOwnCompany() && isAdminOrManager())
          ||
          // In subcontractor context: can create own submissions (DRAFT or SUBMITTED)
          (!isOwnCompany() 
            && request.resource.data.createdByUserId == request.auth.uid
            && request.resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && request.resource.data.status in ['DRAFT', 'SUBMITTED'])
        );
      
      allow update: if authed()
        && sameActiveCompany(resource.data)
        && sameActiveCompany(request.resource.data)
        && (
          // In own company: admins/managers can update (approve/reject)
          (isOwnCompany() && isAdminOrManager())
          ||
          // In subcontractor context: can update own DRAFT submissions to SUBMITTED
          (!isOwnCompany() 
            && resource.data.createdByUserId == request.auth.uid
            && resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && resource.data.status == 'DRAFT'
            && request.resource.data.status == 'SUBMITTED')
        );
      
      allow delete: if authed() 
        && sameActiveCompany(resource.data)
        && (
          // In own company: admins can delete DRAFT submissions
          (isOwnCompany() && isAdmin() && resource.data.status == 'DRAFT')
          ||
          // Subcontractors can delete their own submissions (allows cancel/revert)
          (!isOwnCompany()
            && resource.data.createdByUserId == request.auth.uid
            && resource.data.subcontractorId == subcontractorIdForActiveCompany()
            && resource.data.status in ['DRAFT', 'SUBMITTED'])
        );
    }
    
    // Invoices
    match /invoices/{invoiceId} {
      allow read: if authed() && sameActiveCompany(resource.data);
      allow write: if authed() 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
    }
    
    match /invoiceItems/{itemId} {
      allow read: if authed() && sameActiveCompany(resource.data);
      allow write: if authed() 
        && sameActiveCompany(request.resource.data) 
        && isOwnCompany()
        && isAdminOrManager();
    }
  }
}
